name: Build & Deploy Userservice

on:
  push:
    branches: [ main ]

env:
  NAMESPACE: ase-8
  APP_NAME: userservice
  CONTAINER_NAME: userservice
  IMAGE: ghcr.io/agile-software-engineering-25/team8-backend
  TAG: latest
  K8S_DIR: k8s

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      # baut & pushed das Image nach GHCR (deine bestehende Action)
      - name: Build & (maybe) publish image
        uses: Agile-Software-Engineering-25/build-and-publish-image@v1
        with:
          image_name: team8-backend
          use_cache: "true"
          push: ${{ github.event_name != 'pull_request' }}

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-publish
    steps:
      - uses: actions/checkout@v4

      # kubeconfig aus Secret schreiben
      - name: Write kubeconfig
        run: |
          mkdir -p $HOME/.kube
          printf "%s" "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config

      # Namespace anlegen (idempotent)
      - name: Ensure namespace exists
        run: |
          kubectl get ns ${{ env.NAMESPACE }} >/dev/null 2>&1 || kubectl create ns ${{ env.NAMESPACE }}

      # Deployment auf neues Image setzen (z.B. :latest)
      - name: Update Deployment image
        run: |
          kubectl -n ${{ env.NAMESPACE }} set image deploy/${{ env.APP_NAME }} \
            ${{ env.CONTAINER_NAME }}=${{ env.IMAGE }}:${{ env.TAG }} --record

      # Traefik Middleware + Ingress aus dem Repo anwenden
      # (wenn du sie stattdessen via kustomization.yaml referenzierst,
      #  kannst du hier einfach 'kubectl apply -k k8s/' verwenden)
      - name: Apply Traefik Middleware & Ingress
        run: |
          kubectl -n ${{ env.NAMESPACE }} apply -f ${{ env.K8S_DIR }}/middleware-strip-masterdata.yaml
          kubectl -n ${{ env.NAMESPACE }} apply -f ${{ env.K8S_DIR }}/ingress-userservice.yaml

      # Rollout abwarten
      - name: Wait for rollout
        run: kubectl -n ${{ env.NAMESPACE }} rollout status deploy/${{ env.APP_NAME }} --timeout=180s

      # kurzer Ãœberblick
      - name: Show resources
        run: |
          kubectl -n ${{ env.NAMESPACE }} get deploy,svc,ingress
